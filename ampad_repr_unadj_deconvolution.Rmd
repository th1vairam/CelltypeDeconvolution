---
title: "Cell type deconvolution of reprocessed RNASeq from AMP-AD (unadjusted)"
author: "Thanneer Perumal"
date: "`r date()`"
output: html_document
---
```{r knit2synapse, eval=FALSE}
library(synapseClient)
library(knit2synapse)

synapseLogin()

knit2synapse::knitToFolderEntity(file = "./ampad_repr_unadj_deconvolution.Rmd",
                                 parentId = "syn9890608",
                                 entityName = "AMPAD Reprocessed RNASeq")
```

```{r libs, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE, cache=FALSE}
## It is assumed your working directory is where this file

## Load required libraries
library(CovariateAnalysis) # get it from devtools::install_github('th1vairam/CovariateAnalysis@dev')
library(data.table)
library(tidyr)
library(plyr)
library(dplyr)

library(synapseClient)
library(knitr)
library(githubr)

library(ggplot2)
library(xlsx)

library(doParallel)
library(foreach)

cl = makeCluster(detectCores() - 2)
registerDoParallel(cl)

synapseLogin()

# Source external files
source('./DSA.R')

options(xtable.type="html")

knitr::opts_chunk$set(
  echo=FALSE,
  warning=FALSE,
  message=FALSE,
  error = FALSE,
  tidy = FALSE,
  cache = TRUE)
```

```{r synapse.parameters, include=FALSE, cache=TRUE}
# Synapse parameters
parentId = 'syn9890608';
activityName = 'Celltype deconvolution';

thisFileName <- 'ampad_repr_unadj_deconvolution.Rmd'

# Github link
thisRepo <- getRepo(repository = "th1vairam/CelltypeDeconvolution", ref="branch", refName='deconvolute')
thisFile <- getPermlink(repository = thisRepo, repositoryPath=thisFileName)
```
### Data download
Obtain raw reprocessed counts and filtered covariates from synapse
```{r download.data, cache=TRUE}
# Get covariates from synapse
covariates.ids = c(ROSMAP = 'syn8456631',
                   MSBB = 'syn8484996',
                   MAYO = 'syn8466814')
all.used.ids = as.character(covariates.ids)
covariates = lapply(covariates.ids, downloadFile)
covariates$ROSMAP = covariates$ROSMAP %>%
  dplyr::select(SampleID, Diagnosis) %>%
  dplyr::mutate(BrainRegion = 'DLPFC')
covariates$MSBB = covariates$MSBB %>%
  dplyr::select(SampleID, BrainRegion.Diagnosis) %>%
  tidyr::separate(BrainRegion.Diagnosis, c('BrainRegion', 'Diagnosis'), sep = '\\.')
covariates$MAYO = covariates$MAYO %>%
  dplyr::select(SampleID, BrainRegion.Diagnosis) %>%
  tidyr::separate(BrainRegion.Diagnosis, c('BrainRegion', 'Diagnosis'), sep = '\\.')
covariates = rbindlist(covariates, use.names = T, fill = T, idcol = 'Study')

# Download sample counts
counts.id = c(ROSMAP = 'syn8691134',
              MSBB = 'syn8691099',
              MAYO1 = 'syn8690799', 
              MAYO2 = 'syn8690904')
all.used.ids = c(all.used.ids, as.character(counts.id))
counts = lapply(counts.id, function(id){
  tmp = read.table(synGet(id)@filePath, header=T, sep='\t', check.names = F, row.names = 1) %>%
    rownameToFirstColumn('Gene.ID')
}) %>%
  plyr::join_all(type = 'full')

# Filter Samples
counts = counts[,c('Gene.ID', covariates$SampleID)]

# Convert to logcpm
expr = counts[,-(1)]
rownames(expr) = counts$Gene.ID
expr = limma::voom(expr[-(1:4),])$E

# Get ensembl mapping from synapse
ENSG2SYM = downloadFile('syn9613401')
all.used.ids = c(all.used.ids, 'syn9613401')

GeneID2SYM = data.frame(Gene.ID = rownames(expr),
                        ID = rownames(expr)) %>%
  tidyr::separate(ID, c('ensembl_gene_id', 'position'), sep = '\\.') %>%
  left_join(ENSG2SYM) %>%
  dplyr::group_by(Gene.ID) %>%
  dplyr::slice(1)

expr = WGCNA::collapseRows(expr, GeneID2SYM$hgnc_symbol, GeneID2SYM$Gene.ID)$datETcollapsed
```

### Get gene signatures
```{r gene.sig, fig.height=7, fig.width=15}
# From mariet
load(synGet('syn9818080')@filePath)
all.used.ids = c(all.used.ids, 'syn9818080')

gene.markers.mayo = CellTypeList %>%
      lapply(function(x) data.frame(Symbol = x)) %>%
      rbindlist(idcol = 'CellType') %>%
      dplyr::mutate(CellType = gsub('_Zhang_Neuron_2015', '', CellType))

# From MSSM group
gene.markers.mssm = downloadFile('syn10133143') %>%
  dplyr::rename(Symbol = Gene, CellType = Module) %>%
  dplyr::mutate(CellType = factor(CellType, labels =  c("ast" = "Astrocyte", "end" = "Endothelial", 
                                                        "mic" = "Microglia","neu" = "Neuron",
                                                        "oli" = "Oligodendrocytes", "opc" = "OPC")))
all.used.ids = c(all.used.ids, 'syn10133143')

gl = rbindlist(list(gene.markers.mayo, gene.markers.mssm), use.names = T, fill = T) %>%
  unique() %>%
  dplyr::filter(Symbol %in% rownames(expr))
```

### Naive DSA
```{r dsa.new, fig.height=10, fig.width=10}
# DSA
model = DSA(expr, gl[,c('Symbol', 'CellType')])
w = (t(model$est.weight)/rowSums(t(model$est.weight))) %>%
  rownameToFirstColumn('SampleID') %>%
  tidyr::gather(celltype, fraction, -SampleID)

wperm = plyr::llply(1:100, .fun = function(i, X, Gl){
  X1 = apply(X, 2, function(x){x[sample(1:length(x), length(x))]}) 
  rownames(X1) = rownames(X)
  model = DSA(X1, Gl[,c('Symbol', 'CellType')])
  w = (t(model$est.weight)/rowSums(t(model$est.weight))) %>%
    rownameToFirstColumn('SampleID') %>%
    tidyr::gather(celltype, fraction, -SampleID) %>%
    plyr::rename(c('fraction'=paste0('iter',i)))
}, expr, gl) %>%
  join_all(type = "left")
w$pval = rowSums(wperm[,-(1:2)] >= w[,3])/100
# w$fraction[w$pval > 0.05] = 0
w$fdr = p.adjust(w$pval, method='BH')

w = w %>%
  left_join(covariates)
  
tmp = dplyr::group_by(w, celltype) %>%
  dplyr::summarise(md = median(fdr)) %>%
  dplyr::arrange(md)
w %>% 
  dplyr::filter(Diagnosis != 'OTHER') %>%
  dplyr::mutate(celltype = factor(celltype, levels = tmp$celltype)) %>%
  ggplot(aes(x = celltype, y = fdr, color = Diagnosis)) + geom_boxplot() + theme(axis.text.x = element_text(angle = 45, hjust = 1),legend.position = 'top')

pl = list()
p = ggplot(w %>%
             dplyr::filter(Diagnosis != 'OTHER') %>%
             dplyr::filter(celltype %in% c('Endothelial', 'Neuron', 'Astrocyte')), 
           aes(x = BrainRegion, y = fraction, color = Diagnosis)) + geom_boxplot() + facet_grid(celltype~., scales = 'free_y')
p = p + theme(axis.text.x = element_text(angle = 45, hjust = 1),legend.position = 'top')
p = p + ylab('Estimated Fraction')
pl[[1]] = p

p = ggplot(w %>%
             dplyr::filter(Diagnosis != 'OTHER') %>%
             dplyr::filter(celltype %in% c('Microglia', 'Oligodendrocytes', 'OPC')), 
           aes(x = BrainRegion, y = fraction, color = Diagnosis)) + geom_boxplot() + facet_grid(celltype~., scales = 'free_y')
p = p + theme(axis.text.x = element_text(angle = 45, hjust = 1),legend.position = 'top')
p = p + ylab('Estimated Fraction')
pl[[2]] = p
multiplot(plotlist = pl, cols = 2)
```

### Synapse store
```{r syn.store, cache=TRUE}
CODE = Folder(name = 'AMPAD Reprocessed RNASeq', parentId = parentId)
CODE = synStore(CODE)

save(list = c('w'), file = 'AllResults.RData')
obj = File('AllResults.RData', name = 'All Fractions', parentId = CODE$properties$id)
obj = synStore(obj, activityName = activityName, used = as.character(all.used.ids), executed = thisFile)
```